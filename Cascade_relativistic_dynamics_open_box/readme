## ğŸ§  Algorithm Overview: `SPI_RED_cascade.m`

This function simulates a **single injection** of monoenergetic particles into a thermal background. These injected particles interact via binary collisions with background particles. Over time, energy spreads from the initially injected population to background particles â€” forming a **cascade-like redistribution**.

There is **no repeated injection**; instead, the number of energized (active) particles grows internally through collisions. A reduction mechanism limits the total number of tracked particles for performance.

---

### ğŸ” Step-by-Step Algorithm Sketch
ğŸ”¹ 1. Load background energy distribution
- Load from .mat file (contains â€˜Energy_arrayâ€™)
- Initialize icb (background mass, gamma-beta, energy, etc.)

ğŸ”¹ 2. Compute background temperature (T)
- Solve inverse MJ relation (via Bessel functions)

ğŸ”¹ 3. Inject initial particles
- Inject a fixed number (numofpar) with monoenergetic distribution
- Total energy set by Î³Î² = ic.gb
- This is a single injection at t = 0

ğŸ”¹ 4. Initialize simulation
- t = 0, step = step_inc
- Allocate direction matrix
- Initialize diagnostics: f_max, coll_num, idx = 1

ğŸ” Main Loop: While t < max_time
      â–¸ a. Select two particles
          - One from active/injected set
          - One from fixed background pool
      
      â–¸ b. Assign isotropic directions to both
      
      â–¸ c. Compute collision frequency
          - f_now = f_param Ã— collision_freq(p1, e1, p2, e2)
          - Update f_max
      
      â–¸ d. Advance simulation time
          - Î”t = 1 / (N_active Ã— f_max)
          - t += Î”t
      
      â–¸ e. Perform collision (with probability f_now / f_max)
          - Update energy of injected particle using `collision()`
          - add the background particle.
      
      â–¸ f. Save diagnostics if t > step
          - Save energy histogram, mean KE, confidence bands
          - Save collision-per-particle rate
          - Regenerate direction matrix
          - step += step_inc
      
      â–¸ g. (Optional) Reduce particle number
          - If number of active particles exceeds threshold:
              - Randomly subsample to reduce population
              - This limits memory use but preserves distribution
---

## âš™ï¸ Function Signature

```matlab
[data, str, ic, icb] = SPI_RED_cascade(ic, icb, maxnumofpar, numofpar, max_time, folder)

â¸»

ğŸ“¥ Inputs
	â€¢	ic â€” Struct defining the injected particles:
  	â€¢	ic.m â€” Rest mass of the injected particles
  	â€¢	ic.gb â€” Reduced momentum (Î³Î² = p/m) of the injected particles
	â€¢	icb â€” Struct defining the background particles (Type 2):
  	â€¢	icb.m â€” Rest mass of background particles
  	â€¢	icb.gb â€” Reduced momentum (Î³Î² = p/m)
  	â€¢	icb.N â€” Number of background particles
  	â€¢	icb.folder â€” Folder where the background .mat file is saved (must contain Energy_array)
	â€¢	maxnumofpar â€” Maximum number of injected particles allowed in the simulation
	â€¢	numofpar â€” Number of particles injected at each time step
	â€¢	max_time â€” Maximum simulation time
	â€¢	folder â€” Output folder where the result .mat file will be saved

â¸»

ğŸ“¤ Outputs
	â€¢	data â€” Struct array containing simulation diagnostics over time:
  	â€¢	data(idx).f_sim â€” Normalized energy distribution of injected particles
  	â€¢	data(idx).bins â€” Energy bin centers
  	â€¢	data(idx).kin_energy â€” Mean kinetic energy
  	â€¢	data(idx).time â€” Simulation time at this snapshot
  	â€¢	data(idx).coll_num_pp â€” Number of collisions per particle
  	â€¢	data(idx).f_sim_50, f_sim_100 â€” Uncertainty ranges (from error histograms)
	â€¢	str â€” A string encoding key simulation parameters (used for filename)
	â€¢	ic, icb â€” Updated structs (may include derived fields such as e, ke, g)

â¸»

ğŸ“ Dependencies

This function depends on the following utility files (in Basic functions/):
	â€¢	collision.m â€” Relativistic binary collision solver
	â€¢	frequancy.m â€” Collision rate calculator
	â€¢	randdir_matrix.m â€” Isotropic direction generator
	â€¢	low_err_histlog.m â€” Histogram calculator with uncertainty bands

It also requires:
	â€¢	A .mat file in icb.folder/ containing:
	  â€¢	Energy_array â€” Precomputed energy distribution for background particles

You can use func_One_type_prep.m to generate this file.

â¸»

ğŸ§ª Example Usage

See run_example.m in this repository for a fully commented usage script.

â¸»

ğŸ’¾ Output File

The results will be saved as a .mat file in the specified folder, with a filename constructed from the key parameters:
RD_saves_05/Constant_injection_f_param_1e+01_num_par_inj_1e+04_max_time_1e+04_Bgb_1e-04_gb_1e+00.mat
